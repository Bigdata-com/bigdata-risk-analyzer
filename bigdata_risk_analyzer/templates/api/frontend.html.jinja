
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Risk Analyzer</title>
  <link rel="icon" href="https://app.bigdata.com/favicon.ico"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
      background: #f5f5f5;
      color: #333;
    }
    .input-field {
      width: 300px;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      display: block;
    }
    .btn {
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
    }
    .output-pre {
      background-color: #272822;
      color: #f8f8f2;
      padding: 16px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
      border-radius: 5px;
      margin-top: 20px;
    }
    .error {
      color: red;
    }
    .table-main {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 4px #ccc;
    }
    .mb-20 {
      margin-bottom: 20px;
    }
    .mt-20 {
      margin-top: 20px;
    }
    .mt-2em {
      margin-top: 2em;
    }
    .modal-bg {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      margin: 5vh auto;
      padding: 20px;
      border-radius: 8px;
      width: 80vw;
      max-width: 900px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 18px;
    }
    .modal-copy {
      position: absolute;
      top: 10px;
      right: 50px;
      font-size: 15px;
      padding: 4px 10px;
      cursor: pointer;
    }
    .info-btn {
      background: #f5f5f5;
      color: #000;
      border: none;
      border-radius: 50%;
      width: 1.1em;
      height: 1.1em;
      font-size: 0.9em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <!-- Individual Info Buttons and Modals for Each Label -->
  <div id="infoModalsContainer"></div>
  <h1>Risk Analyzer Request</h1>
  <form id="riskForm" autocomplete="off">

    <label for="main_theme">
      Main Theme: <button type="button" class="info-btn" onclick="showInfoModal('main_theme')" title="Info about Main Theme">i</button>
    </label>
    <input type="text" id="main_theme" class="input-field" placeholder="{{ main_theme }}" required value="{{ main_theme }}" />

    <label for="focus">
      Focus: <button type="button" class="info-btn" onclick="showInfoModal('focus')" title="Info about Focus">i</button>
    </label>
    <textarea id="focus" class="input-field" rows="3" placeholder="{{ focus }}" required>{{ focus }}</textarea>

    <label for="companies">Company Universe:
      <button type="button" class="info-btn" onclick="showInfoModal('companies')" title="Info about Company Universe">i</button>
    </label>
    <input type="text" id="companies" class="input-field" placeholder="{{ companies }}" value="{{ companies }}" />

    <label for="control_entities">
    Control Entities: <button type="button" class="info-btn" onclick="showInfoModal('control_entities')" title="Info about Control Entities">i</button>
    </label>
    <input type="text" id="control_entities" class="input-field" placeholder="{{ control_entities }}" value="{{ control_entities }}" />

    <label for="start_date">
    Start Date: <button type="button" class="info-btn" onclick="showInfoModal('start_date')" title="Info about Start/End Date">i</button>
    </label>
    <input type="date" id="start_date" class="input-field" placeholder="{{ start_date }}" value="{{ start_date }}" />

    <label for="end_date">
    End Date: <button type="button" class="info-btn" onclick="showInfoModal('start_date')" title="Info about Start/End Date">i</button>
    </label>
    <input type="date" id="end_date" class="input-field" placeholder="{{ end_date }}" value="{{ end_date }}" />

    <label for="keywords">
    Keywords: <button type="button" class="info-btn" onclick="showInfoModal('keywords')" title="Info about Keywords">i</button>
    </label>
    <input type="text" id="keywords" class="input-field" placeholder="{{ keywords|join(',') if keywords is defined and keywords else '' }}" value="{{ keywords|join(',') if keywords is defined and keywords else '' }}" />

    <label for="llm_model">LLM Model:</label>
    <input type="text" id="llm_model" class="input-field" placeholder="{{ llm_model }}" value="{{ llm_model }}" />

    <!-- Document Type hidden for now until we improve the UX -->
    <label for="document_type" style="display:none;">
    Document Type: <button type="button" class="info-btn" style="display:none;" onclick="showInfoModal('document_type')" title="Info about Document Type">i</button>
    </label>
    <select id="document_type" class="input-field" style="display:none;">
      <option value="ALL" {% if document_type == 'ALL' %}selected{% endif %}>ALL</option>
      <option value="FILINGS" {% if document_type == 'FILINGS' %}selected{% endif %}>FILINGS</option>
      <option value="TRANSCRIPTS" {% if document_type == 'TRANSCRIPTS' %}selected{% endif %}>TRANSCRIPTS</option>
      <option value="NEWS" {% if document_type == 'NEWS' %}selected{% endif %}>NEWS</option>
      <option value="FILES" {% if document_type == 'FILES' %}selected{% endif %}>FILES</option>
    </select>

    <label for="fiscal_year">
      Fiscal Year: <button type="button" class="info-btn" onclick="showInfoModal('fiscal_year')" title="Info about Fiscal Year">i</button>
    </label>
    <input type="text" id="fiscal_year" class="input-field" placeholder="{{ fiscal_year }}" value="{{ fiscal_year }}" />

    <label for="rerank_threshold">
      Rerank Threshold: <button type="button" class="info-btn" onclick="showInfoModal('rerank_threshold')" title="Info about Rerank Threshold">i</button>
    </label>
    <input type="number" id="rerank_threshold" class="input-field" min="0" max="1" step="0.01" placeholder="{{ rerank_threshold if rerank_threshold is defined and rerank_threshold is not none else '' }}" value="{{ rerank_threshold if rerank_threshold is defined and rerank_threshold is not none else '' }}" />

    <label for="frequency">
      Frequency: <button type="button" class="info-btn" onclick="showInfoModal('frequency')" title="Info about Frequency">i</button>
    </label>
    <select id="frequency" class="input-field">
      <option value="D" {% if frequency == 'D' %}selected{% endif %}>Daily</option>
      <option value="W" {% if frequency == 'W' %}selected{% endif %}>Weekly</option>
      <option value="M" {% if frequency == 'M' %}selected{% endif %}>Monthly</option>
      <option value="3M" {% if frequency == '3M' %}selected{% endif %}>Quarterly</option>
      <option value="Y" {% if frequency == 'Y' %}selected{% endif %}>Yearly</option>
    </select>

    <label for="document_limit">Document Limit:</label>
    <input type="number" id="document_limit" class="input-field" placeholder="{{ document_limit }}" value="{{ document_limit }}" min="1" />

    <label for="batch_size">Batch Size:</label>
    <script>
      // Info modal content for each label
      const infoContents = {
        main_theme: `<b>Main Theme</b>:<br>The overarching risk scenario you want to analyze. It can be specified as a single word or as a short sentence. The risk analyzer will generate a list of sub-themes representing individual, self contained components of the main risk. It can contain multiple core concepts, but we recommend not adding too many core concepts in the same run.<br><i>Examples: "US Import Tariffs against China", "Energy Transition", "Regulatory Changes in AI"</i>`,
        focus: `<b>Focus</b>:<br>Use this parameter to pass additional, custom instructions to the LLM when breaking down the theme into sub-risks. Guide the mindmap creation and customize it to your needs, inject your domain knowledge, and ensure the mindmap covers all required risk dimensions.`,
        companies: `<b>Company Universe</b>:<br>The portfolio of companies you want to screen for exposure, either as a list of RavenPack entity IDs (e.g., ["4A6F00", "D8442A"]) or a watchlist ID (e.g., "44118802-9104-4265-b97a-2e6d88d74893"). Watchlists can be created programmatically using the <a href='https://docs.bigdata.com/getting-started/watchlist_management' target='_blank'>Bigdata.com SDK</a> or through the <a href='https://app.bigdata.com/watchlists' target='_blank'>Bigdata app</a>.`,
        control_entities: `<b>Control Entities</b>:<br>A dict of entities to be co-mentioned with the sentence, companies, and keywords. Specify companies, places, people, concepts, etc. <a href='https://docs.bigdata.com/getting-started/knowledge_graph/find_companies#using-filters' target='_blank'>Learn more</a>.`,
        start_date: `<b>Start/End Date</b>:<br>The start and end of the time sample during which you want to screen your portfolio for thematic exposure. Format: <code>YYYY-MM-DD</code>.`,
        keywords: `<b>Keywords</b>:<br>A list of keywords defining core concepts of the theme (or sub-theme) to be included in the query. Combined with OR and added to Similarity and Entity filter with AND.`,
        document_type: `<b>Document Type</b>:<br>The type of documents to search over. Use this to analyze text data from news, corporate transcripts, or filings. Currently, only "TRANSCRIPTS" is supported.`,
        fiscal_year: `<b>Fiscal Year</b>:<br>For Transcripts and Filings, filter documents by their reporting details. <b>fiscal_year</b> represents the annual reporting period and can be combined with <b>start_date</b> and <b>end_date</b> for time-sensitive queries. Not applicable to News.`,
        rerank_threshold: `<b>Rerank Threshold</b>:<br>Optional, used with sentence search only. Ensures close cosine similarity between sentence embeddings and retrieved chunks. By default, not applied. For most use cases, one-step retrieval is sufficient. <a href='https://docs.bigdata.com/how-to-guides/rerank_search' target='_blank'>Learn more</a>.`,
        frequency: `<b>Frequency</b>:<br>Break down your sample range into higher frequency intervals (<code>D</code>, <code>Y</code>, <code>M</code>, <code>3M</code>, <code>Y</code>). Useful for large samples to control document retrieval over time.`
      };

      function showInfoModal(label) {
        let container = document.getElementById('infoModalsContainer');
        container.innerHTML = `<div class='modal-bg' style='display:block;' onclick='if(event.target==this)this.style.display="none";'>
          <div class='modal-content'>
            <button class='modal-close' onclick='this.closest(".modal-bg").style.display="none"'>&times;</button>
            <div style='font-size:1.1em;'>${infoContents[label] || 'No info available.'}</div>
            <div style='margin-top:18px;font-size:0.95em;'>For a complete list of parameters and their descriptions, refer to the <a href='http://localhost:8000/docs' target='_blank'>API documentation</a>.</div>
          </div>
        </div>`;
      }
    </script>
    <input type="number" id="batch_size" class="input-field" placeholder="{{ batch_size }}" value="{{ batch_size }}" min="1" />

    <button type="submit" class="btn mb-20">Analyze Risk</button>
  </form>
  <div id="spinner" style="display:none;">⏳ Loading...</div>
  <button id="showJsonBtn" class="btn mb-20" style="display:none;">Show raw JSON</button>
  <div id="output"></div>

  <!-- Modal for JSON output -->
  <div id="jsonModal" class="modal-bg">
    <div class="modal-content">
      <button onclick="copyJson()" class="modal-copy">Copy</button>
      <button onclick="closeModal()" class="modal-close">&times;</button>
      <h2>Raw JSON Output</h2>
      <pre id="jsonContent" class="output-pre" style="max-height:60vh;"></pre>
    </div>
  </div>

  <script>
    let lastJson = null;
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const str = String(text);
      return str.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
    }

    function renderRiskReport(data) {
      if (!data || typeof data !== 'object') return '<span class="error">No data to display.</span>';
      let html = '<h2>Risk Analysis Result</h2>';

      // Render risk_scoring (dict of ticker -> CompanyScoring)
      if (data.risk_scoring) {
        html += '<h3>Risk Scoring</h3>';
        html += '<table border="1" cellpadding="6" cellspacing="0" class="table-main">';
        html += '<tr>';
        html += '<th>Ticker</th><th>Sector</th><th>Industry</th><th>Composite Score</th><th>Motivation</th><th>Risks</th>';
        html += '</tr>';
        for (const [ticker, scoring] of Object.entries(data.risk_scoring)) {
          html += '<tr>';
          html += `<td>${escapeHtml(scoring.ticker)}</td>`;
          html += `<td>${escapeHtml(scoring.sector)}</td>`;
          html += `<td>${escapeHtml(scoring.industry)}</td>`;
          html += `<td>${escapeHtml(scoring.composite_score)}</td>`;
          html += `<td>${escapeHtml(scoring.motivation || '')}</td>`;
          // Risks (dict)
          if (scoring.risks) {
            let risksStr = Object.entries(scoring.risks).map(([risk, val]) => `${escapeHtml(risk)}: ${escapeHtml(val)}`).join('<br>');
            html += `<td>${risksStr}</td>`;
          } else {
            html += '<td></td>';
          }
          html += '</tr>';
        }
        html += '</table>';
      }

      // Render risk_taxonomy (tree)
      function renderTaxonomy(node, depth=0) {
        if (!node) return '';
        let pad = '&nbsp;'.repeat(depth * 4);
        let html = `${pad}<b>${escapeHtml(node.label)}</b> (Node: ${escapeHtml(node.node)})`;
        if (node.summary) html += ` - ${escapeHtml(node.summary)}`;
        if (node.keywords && node.keywords.length)
          html += `<br>${pad}<i>Keywords:</i> ${escapeHtml(node.keywords.join(', '))}`;
        if (node.children && node.children.length) {
          html += '<ul>';
          for (const child of node.children) {
            html += '<li>' + renderTaxonomy(child, depth+1) + '</li>';
          }
          html += '</ul>';
        }
        return html;
      }
      if (data.risk_taxonomy) {
        html += '<h3>Risk Taxonomy</h3>';
        html += '<div class="table-main" style="padding:10px;">' + renderTaxonomy(data.risk_taxonomy) + '</div>';
      }

      // Render content (list of LabeledChunk)
      if (data.content && Array.isArray(data.content) && data.content.length) {
        html += '<h3>Labeled Content</h3>';
        html += '<table border="1" cellpadding="6" cellspacing="0" class="table-main">';
        html += '<tr>';
        html += '<th>Date</th><th>Company</th><th>Sector</th><th>Industry</th><th>Country</th><th>Ticker</th><th>Document ID</th><th>Headline</th><th>Quote</th><th>Motivation</th><th>Sub Scenario</th><th>Risk Channel</th><th>Risk Factor</th><th>Highlights</th>';
        html += '</tr>';
        for (const chunk of data.content) {
          html += '<tr>';
          html += `<td>${escapeHtml(chunk.date)}</td>`;
          html += `<td>${escapeHtml(chunk.company)}</td>`;
          html += `<td>${escapeHtml(chunk.sector)}</td>`;
          html += `<td>${escapeHtml(chunk.industry)}</td>`;
          html += `<td>${escapeHtml(chunk.country)}</td>`;
          html += `<td>${escapeHtml(chunk.ticker)}</td>`;
          html += `<td>${escapeHtml(chunk.document_id)}</td>`;
          html += `<td>${escapeHtml(chunk.headline)}</td>`;
          html += `<td>${escapeHtml(chunk.quote)}</td>`;
          html += `<td>${escapeHtml(chunk.motivation)}</td>`;
          html += `<td>${escapeHtml(chunk.sub_scenario)}</td>`;
          html += `<td>${escapeHtml(chunk.risk_channel)}</td>`;
          html += `<td>${escapeHtml(chunk.risk_factor)}</td>`;
          html += `<td>${chunk.highlights && chunk.highlights.length ? escapeHtml(chunk.highlights.join('; ')) : ''}</td>`;
          html += '</tr>';
        }
        html += '</table>';
      }
      return html;
    }

    document.getElementById('riskForm').onsubmit = async function(e) {
      e.preventDefault();
      const output = document.getElementById('output');
      const spinner = document.getElementById('spinner');
      const showJsonBtn = document.getElementById('showJsonBtn');
      const submitBtn = document.querySelector('button[type="submit"]');
      output.innerHTML = '';
      output.classList.remove('error');
      showJsonBtn.style.display = 'none';
      lastJson = null;

      // Disable the submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Waiting for response...';

      // Gather form data
      const main_theme = document.getElementById('main_theme').value.trim();
      const focus = document.getElementById('focus').value.trim();
      const companies = document.getElementById('companies').value.trim();
      const control_entities = document.getElementById('control_entities').value.trim();
      const start_date = document.getElementById('start_date').value;
      const end_date = document.getElementById('end_date').value;
      const keywords = document.getElementById('keywords').value.trim();
      const llm_model = document.getElementById('llm_model').value.trim();
      const document_type = document.getElementById('document_type').value;
      const rerank_threshold = document.getElementById('rerank_threshold').value;
      const frequency = document.getElementById('frequency').value;
      const document_limit = document.getElementById('document_limit').value;
      const batch_size = document.getElementById('batch_size').value;
      const fiscal_year = document.getElementById('fiscal_year').value.trim();

      // Show error if fiscal_year is provided and document_type is not FILINGS, TRANSCRIPTS, or ALL
      if (fiscal_year && !["FILINGS", "TRANSCRIPTS", "ALL"].includes(document_type)) {
        output.innerHTML = '<span class="error">❌ Fiscal year is only allowed for Filings, Transcripts, or All document types.</span>';
        output.classList.add('error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Analyze Risk';
        return;
      }
      // Build request payload
      let payload = {
        main_theme,
        focus,
        llm_model,
        document_type,
        frequency,
        document_limit: document_limit ? parseInt(document_limit) : undefined,
        batch_size: batch_size ? parseInt(batch_size) : undefined,
        fiscal_year: fiscal_year ? fiscal_year : undefined
      };
      // A list of companies
      if (companies.includes(',')) {
        payload.companies = companies.split(',').map(s => s.trim()).filter(Boolean);
      // A single RP Entity ID
      } else if (companies.length === 6) {
        payload.companies = [companies];
      // A watchlist ID
      } else if (companies.length > 6) {
        payload.companies = companies;
      }
      if (control_entities) {
        var clean_control_entities = control_entities.replaceAll(`'`, `"`);
        try {
          payload.control_entities = JSON.parse(clean_control_entities);
        } catch (e) {
          output.innerHTML = '<span class="error">❌ Invalid JSON for control entities.</span>';
          output.classList.add('error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Analyze Risk';
          return;
        }
      }
      if (start_date) payload.start_date = start_date;
      if (end_date) payload.end_date = end_date;
      if (keywords) payload.keywords = keywords.split(',').map(s => s.trim()).filter(Boolean);
      if (rerank_threshold) payload.rerank_threshold = parseFloat(rerank_threshold);

      spinner.style.display = 'block';
      try {
        const response = await fetch('/risk-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}`);
        }
        const data = await response.json();
        lastJson = data;
        output.innerHTML = renderRiskReport(data);
        showJsonBtn.style.display = 'inline-block';
      } catch (err) {
        output.innerHTML = `<span class="error">❌ Error: ${err.message}</span>`;
        output.classList.add('error');
      } finally {
        spinner.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Analyze Risk';
      }
    };

    document.getElementById('showJsonBtn').onclick = function() {
      if (lastJson) {
        document.getElementById('jsonContent').textContent = JSON.stringify(lastJson, null, 2);
        document.getElementById('jsonModal').style.display = 'block';
      }
    };

    function closeModal() {
      document.getElementById('jsonModal').style.display = 'none';
    }
    window.closeModal = closeModal;
    function copyJson() {
      const jsonContent = document.getElementById('jsonContent');
      if (!jsonContent) return;
      const text = jsonContent.innerText || jsonContent.textContent;
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          const btn = document.querySelector('.modal-copy');
          if (btn) {
            const orig = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => { btn.textContent = orig; }, 1200);
          }
        });
      } else {
        // fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          const btn = document.querySelector('.modal-copy');
          if (btn) {
            const orig = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => { btn.textContent = orig; }, 1200);
          }
        } catch (err) {}
        document.body.removeChild(textarea);
      }
    }
  </script>
</body>
</html>
